name: VolGate CI

on:
  push:
    branches: [ feature/integrate-volgate-model, develop, main ]
  pull_request:
    branches: [ develop, main ]

env:
  TRADING_MODE: paper

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov numpy scipy pyyaml
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Run unit tests
      run: |
        pytest tests/ -v --tb=short | tee tests_output.txt
      continue-on-error: false
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: tests-output
        path: tests_output.txt
      if: always()
    
    - name: Run shadow day
      run: |
        chmod +x scripts/*.sh
        ./scripts/run_shadow_day.sh SYMBOL=SPY DATE=2026-01-15
      continue-on-error: true
    
    - name: Generate reconciliation
      run: |
        ./scripts/generate_reconciliation.sh
      continue-on-error: true
    
    - name: Upload reconciliation report
      uses: actions/upload-artifact@v4
      with:
        name: reconciliation-report
        path: |
          reconciliation_report.csv
          replay_output/
      if: always()

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install linters
      run: |
        pip install flake8 black
    
    - name: Run flake8
      run: |
        flake8 workspace/ src/ tests/ --max-line-length=120 --ignore=E501,W503
      continue-on-error: true
    
    - name: Check black formatting
      run: |
        black --check workspace/ src/ tests/ --line-length=120
      continue-on-error: true

  docker:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        if [ -f Dockerfile ]; then
          docker build -t volgate-integration:test .
        else
          echo "No Dockerfile found, skipping Docker build"
        fi
      continue-on-error: true

  safety-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for live trading code
      run: |
        echo "Checking for live trading enablement..."
        
        # Check that TRADING_MODE default is paper
        if grep -r "TRADING_MODE.*=.*['\"]live['\"]" workspace/ src/; then
          echo "ERROR: Found live trading mode enablement!"
          exit 1
        fi
        
        # Check for --live flag assertions
        if grep -r "assert.*--live\|--live.*confirmation" workspace/ src/ tests/; then
          echo "Live trading safeguards found (expected)"
        fi
        
        echo "Safety check passed: Paper trading mode enforced"
    
    - name: Check for secrets in code
      run: |
        echo "Checking for hardcoded secrets..."
        
        # Look for potential API keys
        if grep -rE "(ALPACA|API|SECRET).*=\s*['\"][A-Za-z0-9]{20,}['\"]" --include="*.py" .; then
          echo "WARNING: Potential hardcoded secrets found!"
          exit 1
        fi
        
        echo "No hardcoded secrets found"
